<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>URL Tracker & Manager • Auth</title>
  <style>
    :root {
      --bg: #0b0d12;
      --panel: #121621;
      --panel-2: #171c2a;
      --text: #e7ecf3;
      --muted: #96a0b3;
      --accent: #6aa9ff;
      --accent-2: #78f3d5;
      --danger: #ff6b6b;
      --warn: #ffcc66;
      --ok: #58d68d;
      --border: #202739;
      --chip: #1e2434;
      --chip-text: #cfd8ea;
      --focus: rgba(106,169,255,0.3);
      --shadow: 0 10px 25px rgba(0,0,0,0.35);
      --radius: 14px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      background: radial-gradient(60% 80% at 15% 15%, rgba(35,48,86,0.35), transparent 60%), linear-gradient(145deg, #0a0f1a 0%, #0b0d12 35%, #0a1120 100%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .hidden { display: none !important; }

    /* App Header/Table styles (unchanged core look) */
    .container {
      max-width: 1200px;
      margin: 24px auto 40px;
      padding: 0 16px;
    }
    header.appbar {
      position: sticky; top: 0; z-index: 50;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,13,18,0.7), rgba(11,13,18,0.25) 85%, transparent);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .appbar-inner { max-width: 1200px; margin: 0 auto; padding: 12px 16px; display: flex; align-items: center; gap: 12px; }
    .title-wrap { display: flex; align-items: center; gap: 10px; min-width: 220px; }
    .logo { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #6aa9ff 0%, #78f3d5 100%); box-shadow: 0 10px 28px rgba(106,169,255,0.35), inset 0 0 0 2px rgba(0,0,0,0.2); }
    h1 { font-size: 18px; font-weight: 700; letter-spacing: 0.2px; margin: 0; }
    .hint { font-size: 12px; color: var(--muted); }

    .search-wrap { flex: 1; display: flex; gap: 10px; align-items: center; }
    .search { flex: 1; display: flex; align-items: center; gap: 8px; background: var(--panel); border: 1px solid var(--border); padding: 10px 12px; border-radius: 12px; transition: border-color .2s, box-shadow .2s; }
    .search:focus-within { border-color: var(--accent); box-shadow: 0 0 0 4px var(--focus); }
    .search input { flex: 1; background: transparent; border: 0; outline: 0; color: var(--text); font-size: 14px; }

    .right-actions { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

    .btn {
      display: inline-flex; align-items: center; gap: 8px; border: 1px solid var(--border);
      color: var(--text); background: var(--panel); padding: 10px 12px; border-radius: 12px; cursor: pointer;
      font-weight: 600; font-size: 14px; box-shadow: 0 4px 14px rgba(0,0,0,0.25);
      transition: transform .08s ease, background-color .2s, border-color .2s, box-shadow .2s;
      user-select: none;
    }
    .btn:hover { background: var(--panel-2); }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: linear-gradient(135deg, #2f6ce9, #5f9bff); border-color: rgba(98,156,255,0.35); color: white; }
    .btn.primary:hover { filter: brightness(1.05); }
    .btn.ghost { background: transparent; }
    .btn.danger { background: rgba(255,107,107,0.15); border-color: rgba(255,107,107,0.3); color: #ffdede; }
    .small { padding: 6px 8px; font-size: 12.5px; border-radius: 8px; }

    .panel { background: linear-gradient(180deg, rgba(18,22,33,0.95), rgba(20,24,36,0.96)); border: 1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow); overflow: clip; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); background: linear-gradient(180deg, rgba(17,21,33,0.9), rgba(16,19,29,0.85)); }
    .spacer { flex: 1; }

    .table { width: 100%; border-spacing: 0; }
    .table thead th { text-align: left; font-size: 12px; letter-spacing: 0.5px; text-transform: uppercase; color: var(--muted); padding: 12px 14px; border-bottom: 1px solid var(--border); user-select: none; }
    .table tbody tr { border-bottom: 1px solid var(--border); transition: background .12s ease; }
    .table tbody tr:hover { background: rgba(255,255,255,0.03); }
    .table td { padding: 12px 14px; vertical-align: middle; }
    .url-cell { display: flex; flex-direction: column; gap: 6px; }
    .url-title { font-weight: 700; line-height: 1.1; word-break: break-word; }
    .url { color: var(--muted); font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12.5px; overflow-wrap: anywhere; }
    .tags { display: flex; gap: 6px; flex-wrap: wrap; }
    .tag { background: var(--chip); border: 1px solid rgba(255,255,255,0.08); color: var(--chip-text); padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; }
    .cell-actions { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
    .status-pill { display: inline-flex; align-items: center; gap: 8px; font-size: 12.5px; padding: 6px 8px; border-radius: 999px; border: 1px solid var(--border); background: var(--panel); }
    .status-ok { color: #b7ffd7; background: rgba(88,214,141,0.08); border-color: rgba(88,214,141,0.25); }
    .status-bad { color: #ffd0d0; background: rgba(255,107,107,0.08); border-color: rgba(255,107,107,0.25); }
    .status-unknown { color: #f6e9c8; background: rgba(255,204,102,0.08); border-color: rgba(255,204,102,0.25); }

    .footer { display: flex; justify-content: space-between; align-items: center; padding: 14px; color: var(--muted); font-size: 13px; border-top: 1px solid var(--border); background: linear-gradient(0deg, rgba(17,21,33,0.9), rgba(16,19,29,0.85)); border-bottom-left-radius: 14px; border-bottom-right-radius: 14px; }

    .chips { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    .chip-filter { cursor: pointer; }
    .chip-filter.active { outline: 2px solid var(--accent); }

    .toast { position: fixed; bottom: 20px; right: 20px; z-index: 200; display: grid; gap: 10px; }
    .toast .msg { background: #101525; border: 1px solid var(--border); color: var(--text); padding: 10px 12px; border-radius: 10px; box-shadow: var(--shadow); }

    @media (max-width: 720px) {
      .appbar-inner { flex-wrap: wrap; }
      .right-actions { width: 100%; justify-content: flex-start; }
      .table thead { display: none; }
      .table, .table tbody, .table tr, .table td { display: block; width: 100%; }
      .table tbody tr { margin: 10px; border: 1px solid var(--border); border-radius: 12px; background: var(--panel); }
      .table td { padding: 10px 12px; }
      .cell-actions { padding-top: 4px; }
    }

    /* Modal */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 100; background: rgba(0,0,0,0.55); backdrop-filter: blur(6px); }
    .modal.open { display: flex; }
    .modal .sheet { width: min(860px, 92vw); background: linear-gradient(180deg, rgba(18,22,33,0.98), rgba(17,20,31,0.98)); border: 1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden; }
    .sheet header { padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
    .sheet h3 { margin: 0; font-size: 16px; }
    .sheet .content { padding: 16px; display: grid; gap: 14px; grid-template-columns: 1fr 1fr; }
    .sheet .row { display: grid; gap: 8px; }
    .sheet label { font-weight: 700; font-size: 13px; color: var(--muted); }
    .sheet input[type="text"], .sheet input[type="url"], .sheet textarea, .sheet select {
      width: 100%; background: var(--panel); border: 1px solid var(--border); border-radius: 10px; color: var(--text);
      padding: 10px 12px; outline: none; font-size: 14px;
    }
    .sheet input:focus, .sheet textarea:focus, .sheet select:focus { border-color: var(--accent); box-shadow: 0 0 0 4px var(--focus); }
    .sheet textarea { min-height: 84px; resize: vertical; }
    .sheet .grid-span-2 { grid-column: span 2; }
    .sheet footer { padding: 12px 16px; display: flex; gap: 8px; justify-content: flex-end; border-top: 1px solid var(--border); background: linear-gradient(180deg, rgba(17,21,33,0.9), rgba(16,19,29,0.85)); }

    /* Auth view */
    .auth-view {
      position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
      padding: 24px; z-index: 60;
      background: linear-gradient(145deg, rgba(10,15,26,0.9), rgba(10,16,32,0.9));
      backdrop-filter: blur(6px);
    }
    .auth-card {
      width: min(520px, 92vw);
      background: linear-gradient(180deg, rgba(18,22,33,0.98), rgba(17,20,31,0.98));
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .auth-card header {
      padding: 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border);
    }
    .auth-card h2 { margin: 0; font-size: 18px; }
    .tabs { display: flex; gap: 6px; padding: 10px 12px; border-bottom: 1px solid var(--border); }
    .tab-btn {
      padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--panel);
      color: var(--text); font-weight: 700; cursor: pointer; font-size: 13px;
    }
    .tab-btn.active { outline: 2px solid var(--accent); }
    .auth-body { padding: 16px; display: grid; gap: 12px; }
    .auth-row { display: grid; gap: 6px; }
    .auth-row label { font-weight: 700; font-size: 13px; color: var(--muted); }
    .auth-input {
      background: var(--panel); border: 1px solid var(--border); border-radius: 10px; color: var(--text);
      padding: 10px 12px; outline: none; font-size: 14px;
    }
    .auth-input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px var(--focus); }
    .auth-actions { display: flex; gap: 8px; justify-content: flex-end; align-items: center; }
    .auth-error { color: #ffd0d0; background: rgba(255,107,107,0.08); border: 1px solid rgba(255,107,107,0.25); padding: 8px 10px; border-radius: 10px; font-size: 13px; }
    .auth-note { color: var(--muted); font-size: 12px; }
    .inline { display: inline-flex; align-items: center; gap: 8px; }
    .kbd { background: #0d111a; border: 1px solid #202739; color: #cdd9f0; border-bottom-width: 3px; border-radius: 8px; padding: 2px 6px; font-size: 12px; font-weight: 700; }
    .avatar {
      width: 28px; height: 28px; border-radius: 999px; background: linear-gradient(135deg, #6aa9ff, #78f3d5);
      display: inline-flex; align-items: center; justify-content: center; color: #0b1220; font-weight: 900; font-size: 12px;
    }

    /* Category pill */
    .cat-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12.5px;
      font-weight: 700;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
    }
    .cat-swatch {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
  </style>
</head>
<body>

  <!-- Auth View -->
  <div id="authView" class="auth-view hidden" aria-hidden="true">
    <div class="auth-card" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <header>
        <div class="inline">
          <div class="logo" style="width:36px;height:36px;border-radius:10px;overflow:hidden;">
            <img
                src="generated-image.png"
                alt="Your Brand"
                width="36" height="36"
                style="display:block;width:100%;height:100%;object-fit:contain;"
            />
            </div>
          <h2 id="authTitle">Welcome</h2>
        </div>
        <div class="hint">Local-first • Private to your browser</div>
      </header>

      <div class="tabs">
        <button id="tabSignIn" class="tab-btn active" data-tab="signin">Sign In</button>
        <button id="tabSignUp" class="tab-btn" data-tab="signup">Sign Up</button>
      </div>

      <div id="signinPane" class="auth-body">
        <div id="signinErr" class="auth-error hidden"></div>
        <div class="auth-row">
          <label for="si_email">Email</label>
          <input id="si_email" class="auth-input" type="email" placeholder="you@example.com" autocomplete="username" />
        </div>
        <div class="auth-row">
          <label for="si_password">Password</label>
          <input id="si_password" class="auth-input" type="password" placeholder="••••••••" autocomplete="current-password" />
        </div>
        <div class="inline" style="justify-content: space-between;">
          <label class="inline"><input type="checkbox" id="si_remember" /> Remember me</label>
          <span class="auth-note">Use <span class="kbd">Tab</span> / <span class="kbd">Enter</span> to move fast</span>
        </div>
        <div class="auth-actions">
          <button id="btnSignIn" class="btn primary">Sign In</button>
        </div>
        <div class="auth-note">This signs you into this browser only. No servers involved.</div>
      </div>

      <div id="signupPane" class="auth-body hidden">
        <div id="signupErr" class="auth-error hidden"></div>
        <div class="auth-row">
          <label for="su_email">Email</label>
          <input id="su_email" class="auth-input" type="email" placeholder="you@example.com" autocomplete="username" />
        </div>
        <div class="auth-row">
          <label for="su_password">Password</label>
          <input id="su_password" class="auth-input" type="password" placeholder="At least 8 characters" autocomplete="new-password" />
        </div>
        <div class="auth-row">
          <label for="su_confirm">Confirm password</label>
          <input id="su_confirm" class="auth-input" type="password" placeholder="Re-enter password" autocomplete="new-password" />
        </div>
        <div class="auth-actions">
          <button id="btnSignUp" class="btn primary">Create Account</button>
        </div>
        <div class="auth-note">Passwords are salted + hashed locally (PBKDF2). Not for multi-user production use.</div>
      </div>
    </div>
  </div>

  <!-- App View (hidden until signed in) -->
  <div id="appView" class="hidden">
    <header class="appbar">
      <div class="appbar-inner">
        <div class="title-wrap">
            <div class="logo" style="width:36px;height:36px;border-radius:10px;overflow:hidden;">
            <img
                src="generated-image.png"
                alt="Your Brand"
                width="36" height="36"
                style="display:block;width:100%;height:100%;object-fit:contain;"
            />
            </div>
          <div>
            <h1>URL Tracker & Manager</h1>
            <div class="hint">Track clicks, tags, UTM, status • Local-first</div>
          </div>
        </div>

        <div class="search-wrap">
          <div class="search" title="Search title, URL or #tag">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
            <input id="q" placeholder="Search title, URL, or #tag…" />
          </div>
          <button class="btn" id="clearFilters" title="Clear filters">Clear</button>
        </div>

        <div class="right-actions">
          <button class="btn primary" id="addBtn" title="Add a new link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            New URL
          </button>
          <button class="btn" id="exportBtn" title="Export JSON">Export</button>
          <label class="btn" for="importFile" title="Import JSON">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 3v12m0 0l-3.5-3.5M12 15l3.5-3.5M5 21h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Import
          </label>
          <input type="file" id="importFile" accept="application/json" class="hidden" />

          <div id="userArea" class="inline hidden" style="margin-left: 6px;">
            <div class="btn ghost" id="userBadge" title="Signed in user">
              <span class="avatar" id="userAvatar">U</span>
              <span id="userEmail" style="margin-left: 6px;"></span>
            </div>
            <button id="signOutBtn" class="btn">Sign out</button>
          </div>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="panel">
        <div class="toolbar">
          <div class="chips" id="activeFilters"></div>

          <select id="catFilter" title="Filter by category" class="btn">
            <option value="">All categories</option>
          </select>

          <div class="spacer"></div>
          <select id="sortBy" title="Sort by" class="btn">
            <option value="createdAt-desc">Newest</option>
            <option value="createdAt-asc">Oldest</option>
            <option value="clickCount-desc">Most clicked</option>
            <option value="clickCount-asc">Least clicked</option>
            <option value="title-asc">Title A→Z</option>
            <option value="title-desc">Title Z→A</option>
            <option value="category-asc">Category A→Z</option>
            <option value="category-desc">Category Z→A</option>
            <option value="lastOpened-desc">Recently opened</option>
            <option value="lastOpened-asc">Least recently opened</option>
          </select>
          <button class="btn" id="bulkCheck" title="Check status for all shown">Check Status</button>
        </div>

        <table class="table" id="table">
          <thead>
            <tr>
              <th style="width:36px"></th>
              <th>Link</th>
              <th style="width:160px">Tags</th>
              <th style="width:160px">Category</th>
              <th style="width:120px">Clicks</th>
              <th style="width:160px">Status</th>
              <th style="width:270px">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <div class="footer">
          <div class="stats">
            <div>Total: <span id="statTotal">0</span></div>
            <div>Shown: <span id="statShown">0</span></div>
            <div>Clicks: <span id="statClicks">0</span></div>
          </div>
          <div class="hint">
            Tip: Type #tag in search to filter by tag. Press / to focus search.
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Add/Edit -->
    <div class="modal" id="modal">
      <div class="sheet">
        <header>
          <h3 id="modalTitle">Add URL</h3>
          <button class="btn" id="closeModal" aria-label="Close">Close</button>
        </header>
        <form id="form">
          <div class="content">
            <div class="row grid-span-2">
              <label>Destination URL</label>
              <input type="url" id="f_url" placeholder="https://example.com/page" required />
              <div class="hint">Paste the full URL. We’ll track clicks and can build UTM parameters for campaigns.</div>
            </div>

            <div class="row">
              <label>Title</label>
              <input type="text" id="f_title" placeholder="Readable title (auto if possible)" />
            </div>

            <div class="row">
              <label>Tags (comma or space separated)</label>
              <input type="text" id="f_tags" placeholder="marketing, docs, #personal" />
            </div>

            <div class="row">
              <label>Category</label>
              <div class="inline" style="gap:8px;">
                <select id="f_category" style="flex:1;">
                  <option value="">— None —</option>
                </select>
                <button type="button" class="btn small" id="addCatBtn">New</button>
              </div>
              <div id="addCatFields" class="row hidden">
                <div class="inline" style="gap:8px;">
                  <input id="newCatName" type="text" placeholder="e.g., AI" class="auth-input" style="flex:1;" />
                  <input id="newCatColor" type="color" value="#8a63d2" />
                  <button type="button" class="btn small" id="saveCatBtn">Add</button>
                </div>
                <div class="hint">Name + color. Saved per account; appears in filters and forms.</div>
              </div>
              <div class="hint">Pick one category (e.g., AI, Social Media, Entertainment). Use tags for finer grouping.</div>
            </div>

            <div class="row">
              <label>Short slug (optional)</label>
              <div class="inline">
                <input type="text" id="f_slug" placeholder="e.g., launch" />
                <button type="button" class="btn small" id="genSlug">Generate</button>
              </div>
              <div class="hint">Short links use this page: ?go=slug</div>
            </div>

            <div class="row grid-span-2">
              <label>Notes</label>
              <textarea id="f_note" placeholder="Any context, owner, checklist, etc."></textarea>
            </div>

            <div class="row">
              <label class="inline">
                <input type="checkbox" id="f_pin" />
                <span>Pin</span>
              </label>
            </div>

            <div class="row grid-span-2">
              <label class="inline">
                <input type="checkbox" id="utm_toggle" />
                <span>Build UTM parameters</span>
              </label>
              <div id="utm_fields" class="row grid-span-2 hidden">
                <div class="row">
                  <label>utm_source</label>
                  <input type="text" id="utm_source" placeholder="newsletter" />
                </div>
                <div class="row">
                  <label>utm_medium</label>
                  <input type="text" id="utm_medium" placeholder="email" />
                </div>
                <div class="row">
                  <label>utm_campaign</label>
                  <input type="text" id="utm_campaign" placeholder="spring_launch" />
                </div>
                <div class="row">
                  <label>utm_term</label>
                  <input type="text" id="utm_term" placeholder="keyword" />
                </div>
                <div class="row">
                  <label>utm_content</label>
                  <input type="text" id="utm_content" placeholder="banner_a" />
                </div>
                <div class="row grid-span-2">
                  <button type="button" class="btn small" id="utm_preview_btn">Preview URL with UTM</button>
                  <div id="utm_preview" class="hint selectable"></div>
                </div>
              </div>
            </div>

          </div>
          <footer>
            <button type="button" class="btn" id="fetchTitle">Auto title</button>
            <div class="spacer"></div>
            <button type="button" class="btn danger" id="deleteBtn" class="hidden">Delete</button>
            <button type="submit" class="btn primary">Save</button>
          </footer>
        </form>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ---------- Helpers ----------
    const el = (sel, root=document) => root.querySelector(sel);
    const els = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const now = () => Date.now();
    const uid = () => (crypto.randomUUID ? crypto.randomUUID() : 'id-' + Math.random().toString(36).slice(2));
    const clamp = (n, a, b) => Math.min(Math.max(n, a), b);
    const debounce = (fn, ms=250) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; };

    const toTags = (str) => (str || '')
      .replace(/[#]/g, '')
      .split(/[, ]+/)
      .map(s => s.trim().toLowerCase())
      .filter(Boolean)
      .slice(0, 20);

    const normalizeUrl = (input) => {
      try {
        const u = new URL(input);
        u.hash = '';
        u.hostname = u.hostname.toLowerCase();
        const entries = [...u.searchParams.entries()].sort((a,b) => a[0].localeCompare(b[0]));
        u.search = entries.map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
        if ((u.protocol === 'http:' && u.port === '80') || (u.protocol === 'https:' && u.port === '443')) u.port = '';
        if (u.pathname !== '/' && u.pathname.endsWith('/')) u.pathname = u.pathname.slice(0,-1);
        return u.toString();
      } catch { return input.trim(); }
    };

    const buildUtm = (url, utm) => {
      try {
        const u = new URL(url);
        const set = (k,v) => v ? u.searchParams.set(k, v) : u.searchParams.delete(k);
        set('utm_source', utm.source);
        set('utm_medium', utm.medium);
        set('utm_campaign', utm.campaign);
        set('utm_term', utm.term);
        set('utm_content', utm.content);
        return u.toString();
      } catch { return url; }
    };

    const copy = async (text) => {
      try { await navigator.clipboard.writeText(text); toast('Copied to clipboard'); }
      catch { toast('Copy failed'); }
    };

    const toast = (msg, ms=2400) => {
      const box = el('#toast');
      const div = document.createElement('div');
      div.className = 'msg';
      div.textContent = msg;
      box.appendChild(div);
      setTimeout(() => { div.style.opacity = '0'; div.style.transform = 'translateY(4px)'; }, ms-350);
      setTimeout(() => div.remove(), ms);
    };

    const timeAgo = (t) => {
      if (!t) return '—';
      const s = Math.floor((Date.now() - t)/1000);
      if (s < 60) return `${s}s ago`;
      const m = Math.floor(s/60);
      if (m < 60) return `${m}m ago`;
      const h = Math.floor(m/60);
      if (h < 24) return `${h}h ago`;
      const d = Math.floor(h/24);
      if (d < 30) return `${d}d ago`;
      const mo = Math.floor(d/30);
      if (mo < 12) return `${mo}mo ago`;
      const y = Math.floor(mo/12);
      return `${y}y ago`;
    };

    const escapeHtml = (str='') => str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[s]));

    const fmtUrlHost = (u) => { try { return new URL(u).host; } catch { return ''; } };

    // ---------- Categories (per-user) ----------
    const DEFAULT_CATEGORIES = [
      { id: 'ai',            name: 'AI',            color: '#8a63d2' },
      { id: 'social-media',  name: 'Social Media',  color: '#1da1f2' },
      { id: 'entertainment', name: 'Entertainment', color: '#ff8a65' },
      { id: 'news',          name: 'News',          color: '#f39c12' },
      { id: 'dev',           name: 'Developer',     color: '#2ecc71' },
      { id: 'docs',          name: 'Docs',          color: '#3498db' },
      { id: 'education',     name: 'Education',     color: '#16a085' },
      { id: 'finance',       name: 'Finance',       color: '#27ae60' },
      { id: 'shopping',      name: 'Shopping',      color: '#e91e63' },
      { id: 'marketing',     name: 'Marketing',     color: '#ff6b6b' },
      { id: 'personal',      name: 'Personal',      color: '#9b59b6' },
      { id: 'tools',         name: 'Tools',         color: '#95a5a6' },
      { id: 'other',         name: 'Other',         color: '#7f8c8d' },
    ];
    let categories = [];
    let filterCategory = '';

    const catStoreKey = () => (typeof currentUser !== 'undefined' && currentUser && currentUser.id)
      ? `url-manager:v1:categories:${currentUser.id}`
      : 'url-manager:v1:categories';

    function loadCategories() {
      try {
        const raw = localStorage.getItem(catStoreKey());
        const parsed = raw ? JSON.parse(raw) : null;
        return (Array.isArray(parsed) && parsed.length) ? parsed : DEFAULT_CATEGORIES.slice();
      } catch {
        return DEFAULT_CATEGORIES.slice();
      }
    }
    function saveCategories(cats = categories) {
      localStorage.setItem(catStoreKey(), JSON.stringify(cats));
    }
    function getCategoryById(id) {
      return categories.find(c => c.id === id);
    }
    function slugify(s='') {
      return s.toLowerCase().trim()
        .replace(/&/g, 'and')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '');
    }
    function hexToRgb(hex) {
      let h = hex.replace('#','');
      if (h.length === 3) h = h.split('').map(ch => ch+ch).join('');
      const num = parseInt(h, 16);
      return { r: (num>>16)&255, g: (num>>8)&255, b: num&255 };
    }
    function renderCategoryControls() {
      const catSel = el('#f_category');
      const filterSel = el('#catFilter');
      if (catSel) {
        catSel.innerHTML = '<option value="">— None —</option>' +
          categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      }
      if (filterSel) {
        const current = filterSel.value;
        filterSel.innerHTML = '<option value="">All categories</option>' +
          categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        if (current && categories.some(c => c.id === current)) filterSel.value = current;
      }
    }
    function makeCatPill(cat) {
      const pill = document.createElement('span');
      pill.className = 'cat-pill';
      const sw = document.createElement('span');
      sw.className = 'cat-swatch';
      sw.style.backgroundColor = cat.color;
      pill.appendChild(sw);
      pill.appendChild(document.createTextNode(cat.name));
      try {
        const { r,g,b } = hexToRgb(cat.color);
        pill.style.backgroundColor = `rgba(${r},${g},${b},0.12)`;
        pill.style.borderColor = `rgba(${r},${g},${b},0.35)`;
      } catch {}
      pill.style.cursor = 'pointer';
      pill.title = `Filter by ${cat.name}`;
      pill.onclick = () => {
        const f = el('#catFilter');
        if (f) f.value = cat.id;
        filterCategory = cat.id;
        render();
      };
      return pill;
    }

    // ---------- Auth storage & crypto ----------
    const AUTH_USERS_KEY = 'um:v1:users';
    const SESSION_KEY = 'um:v1:session';
    const LEGACY_ITEMS_KEY = 'url-manager:v1:items'; // old version pre-auth

    const enc = new TextEncoder();
    const toB64 = (buf) => { let bin = ''; const bytes = new Uint8Array(buf); for (let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]); return btoa(bin); };
    const fromB64 = (b64) => { const bin = atob(b64); const bytes = new Uint8Array(bin.length); for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i); return bytes; };

    async function hashPassword(password, saltB64=null) {
      const salt = saltB64 ? fromB64(saltB64) : crypto.getRandomValues(new Uint8Array(16));
      const key = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveBits']);
      const bits = await crypto.subtle.deriveBits({ name: 'PBKDF2', hash: 'SHA-256', salt, iterations: 120000 }, key, 256);
      const hashB64 = toB64(bits);
      const saltOut = saltB64 || toB64(salt);
      return { hashB64, saltB64: saltOut };
    }

    const loadUsers = () => { try { return JSON.parse(localStorage.getItem(AUTH_USERS_KEY) || '[]'); } catch { return []; } };
    const saveUsers = (u) => localStorage.setItem(AUTH_USERS_KEY, JSON.stringify(u));
    const getSession = () => { try { return JSON.parse(localStorage.getItem(SESSION_KEY) || sessionStorage.getItem(SESSION_KEY) || 'null'); } catch { return null; } };
    const setSession = (session, remember=false) => {
      const data = JSON.stringify(session);
      if (remember) localStorage.setItem(SESSION_KEY, data);
      else sessionStorage.setItem(SESSION_KEY, data);
    };
    const clearSession = () => { localStorage.removeItem(SESSION_KEY); sessionStorage.removeItem(SESSION_KEY); };

    const emailOk = (e) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((e||'').trim());
    const passOk = (p) => (p||'').length >= 8;

    function userInitial(email='') {
      const ch = (email.trim()[0] || 'U').toUpperCase();
      return /[A-Z0-9]/i.test(ch) ? ch : 'U';
    }

    // ---------- Per-user storage ----------
    const storeKeyFor = (userId) => `url-manager:v1:items:${userId}`;
    const settingsKeyFor = (userId) => `url-manager:v1:settings:${userId}`;

    const loadItemsFor = (userId) => {
      try { return JSON.parse(localStorage.getItem(storeKeyFor(userId)) || '[]'); } catch { return []; }
    };
    const saveItemsFor = (userId, items) => localStorage.setItem(storeKeyFor(userId), JSON.stringify(items));
    const loadSettingsFor = (userId) => { try { return JSON.parse(localStorage.getItem(settingsKeyFor(userId)) || '{}'); } catch { return {}; } };
    const saveSettingsFor = (userId, s) => localStorage.setItem(settingsKeyFor(userId), JSON.stringify(s));

    // ---------- App state (populated after login) ----------
    let currentUser = null; // { id, email, ... }
    let items = [];         // this user's items
    let sortBy = 'createdAt-desc';
    let filterText = '';
    let filterTags = new Set();
    let editingId = null;

    // ---------- Auth UI logic ----------
    const authView = el('#authView');
    const appView = el('#appView');

    function showAuth() {
      appView.classList.add('hidden');
      authView.classList.remove('hidden');
      authView.setAttribute('aria-hidden', 'false');
      el('#si_email').focus();
    }
    function showApp() {
      authView.classList.add('hidden');
      authView.setAttribute('aria-hidden', 'true');
      appView.classList.remove('hidden');
    }

    function switchTab(tab) {
      const siBtn = el('#tabSignIn');
      const suBtn = el('#tabSignUp');
      const siPane = el('#signinPane');
      const suPane = el('#signupPane');
      const err1 = el('#signinErr'), err2 = el('#signupErr');
      err1.classList.add('hidden'); err2.classList.add('hidden');
      if (tab === 'signin') {
        siBtn.classList.add('active'); suBtn.classList.remove('active');
        siPane.classList.remove('hidden'); suPane.classList.add('hidden');
        el('#si_email').focus();
      } else {
        suBtn.classList.add('active'); siBtn.classList.remove('active');
        suPane.classList.remove('hidden'); siPane.classList.add('hidden');
        el('#su_email').focus();
      }
    }

    el('#tabSignIn').addEventListener('click', () => switchTab('signin'));
    el('#tabSignUp').addEventListener('click', () => switchTab('signup'));

    async function handleSignUp() {
      const email = el('#su_email').value.trim();
      const pass = el('#su_password').value;
      const conf = el('#su_confirm').value;
      const err = el('#signupErr');

      err.classList.add('hidden'); err.textContent = '';
      if (!emailOk(email)) { err.textContent = 'Please enter a valid email.'; err.classList.remove('hidden'); return; }
      if (!passOk(pass)) { err.textContent = 'Password must be at least 8 characters.'; err.classList.remove('hidden'); return; }
      if (pass !== conf) { err.textContent = 'Passwords do not match.'; err.classList.remove('hidden'); return; }

      const users = loadUsers();
      const exists = users.find(u => u.emailLower === email.toLowerCase());
      if (exists) { err.textContent = 'An account with this email already exists.'; err.classList.remove('hidden'); return; }

      const { hashB64, saltB64 } = await hashPassword(pass);
      const user = {
        id: uid(),
        email,
        emailLower: email.toLowerCase(),
        passHash: hashB64,
        salt: saltB64,
        createdAt: now(),
        lastLoginAt: 0
      };
      users.push(user);
      saveUsers(users);

      currentUser = user;
      currentUser.lastLoginAt = now();
      setSession({ userId: user.id, email: user.email }, true);
      await initAppForUser(user);
      toast('Account created. Signed in.');
    }

    async function handleSignIn() {
      const email = el('#si_email').value.trim();
      const pass = el('#si_password').value;
      const remember = el('#si_remember').checked;
      const err = el('#signinErr');

      err.classList.add('hidden'); err.textContent = '';
      if (!emailOk(email)) { err.textContent = 'Please enter a valid email.'; err.classList.remove('hidden'); return; }
      if (!passOk(pass)) { err.textContent = 'Password must be at least 8 characters.'; err.classList.remove('hidden'); return; }

      const users = loadUsers();
      const user = users.find(u => u.emailLower === email.toLowerCase());
      if (!user) { err.textContent = 'No account found for this email.'; err.classList.remove('hidden'); return; }

      const { hashB64 } = await hashPassword(pass, user.salt);
      if (hashB64 !== user.passHash) { err.textContent = 'Incorrect password.'; err.classList.remove('hidden'); return; }

      user.lastLoginAt = now();
      saveUsers(users);

      currentUser = user;
      setSession({ userId: user.id, email: user.email }, remember);
      await initAppForUser(user);
      toast('Signed in');
    }

    el('#btnSignUp').addEventListener('click', handleSignUp);
    el('#btnSignIn').addEventListener('click', handleSignIn);
    ['su_email','su_password','su_confirm','si_email','si_password'].forEach(id => {
      el('#'+id).addEventListener('keydown', (e) => { if (e.key === 'Enter') {
        if (!el('#signupPane').classList.contains('hidden')) handleSignUp();
        else handleSignIn();
      }});
    });

    // ---------- Initialize app for a user ----------
    async function initAppForUser(user) {
      // Load user data
      items = loadItemsFor(user.id);
      const settings = loadSettingsFor(user.id) || {};
      sortBy = settings.sortBy || 'createdAt-desc';

      // Categories for this user
      categories = loadCategories();
      renderCategoryControls();

      // If empty and legacy data exists, offer to migrate
      try {
        const legacy = JSON.parse(localStorage.getItem(LEGACY_ITEMS_KEY) || 'null');
        if (Array.isArray(legacy) && legacy.length && items.length === 0) {
          if (confirm('Found links from an older version. Import them to your account?')) {
            items = legacy.map(it => ({ ...it, id: it.id || uid() }));
            saveItemsFor(user.id, items);
            toast('Imported legacy items');
          }
        }
      } catch {}

      // Seed sample if totally empty
      if (items.length === 0) {
        const sample = [{
          id: uid(),
          url: 'https://example.com/',
          normalizedUrl: normalizeUrl('https://example.com/'),
          title: 'Example',
          tags: ['sample','demo'],
          category: 'other',
          slug: 'exmpl',
          note: 'This is a sample entry. Add your own!',
          pinned: true,
          createdAt: now(),
          updatedAt: now(),
          clickCount: 0,
          lastOpened: 0,
          status: null
        }];
        items = sample;
        saveItemsFor(user.id, items);
      }

      // Show UI
      el('#userArea').classList.remove('hidden');
      el('#userEmail').textContent = user.email;
      el('#userAvatar').textContent = userInitial(user.email);

      showApp();
      render();

      // If there's a short link param, try redirect now
      maybeRedirectForUser();
    }

    // ---------- App rendering and actions ----------
    const tbody = el('#tbody');
    const qInput = el('#q');
    const activeFilters = el('#activeFilters');

    const getFilteredSorted = () => {
      const text = filterText.trim().toLowerCase();
      const tagFilters = [...filterTags];

      let list = items.slice();

      if (text) {
        list = list.filter(i => {
          const hay = [i.title || '', i.url || '', ...(i.tags||[])].join(' ').toLowerCase();
          return hay.includes(text) || (text.startsWith('#') && (i.tags||[]).includes(text.slice(1)));
        });
      }
      if (tagFilters.length) list = list.filter(i => tagFilters.every(t => (i.tags||[]).includes(t)));
      if (filterCategory) list = list.filter(i => (i.category || '') === filterCategory);

      const [field, dir] = sortBy.split('-');
      const mul = dir === 'asc' ? 1 : -1;
      list.sort((a,b) => {
        if (field === 'category') {
          const nameA = (getCategoryById(a.category)?.name || '').toLowerCase();
          const nameB = (getCategoryById(b.category)?.name || '').toLowerCase();
          return nameA.localeCompare(nameB) * mul;
        }
        const av = (a[field] ?? '') || '';
        const bv = (b[field] ?? '') || '';
        if (field === 'title') return av.localeCompare(bv) * mul;
        if (field === 'clickCount') return ((a.clickCount||0) - (b.clickCount||0)) * mul;
        if (field === 'lastOpened' || field === 'createdAt') return (((a[field]||0) - (b[field]||0)) * mul);
        return 0;
      });

      const pinned = list.filter(i => i.pinned);
      const rest = list.filter(i => !i.pinned);
      return [...pinned, ...rest];
    };

    const renderFilters = () => {
      activeFilters.innerHTML = '';
      if (filterText) {
        const chip = document.createElement('div');
        chip.className = 'tag chip-filter active';
        chip.textContent = '“' + filterText + '”';
        chip.title = 'Click to clear search';
        chip.onclick = () => { filterText = ''; qInput.value = ''; render(); };
        activeFilters.appendChild(chip);
      }
      if (filterTags.size) {
        filterTags.forEach(t => {
          const chip = document.createElement('div');
          chip.className = 'tag chip-filter active';
          chip.textContent = '#' + t;
          chip.title = 'Click to remove tag filter';
          chip.onclick = () => { filterTags.delete(t); render(); };
          activeFilters.appendChild(chip);
        });
      }
      if (filterCategory) {
        const cat = getCategoryById(filterCategory);
        if (cat) {
          const chip = document.createElement('div');
          chip.className = 'tag chip-filter active';
          chip.textContent = 'Category: ' + cat.name;
          chip.title = 'Click to clear category filter';
          chip.onclick = () => {
            filterCategory = '';
            const f = el('#catFilter'); if (f) f.value = '';
            render();
          };
          activeFilters.appendChild(chip);
        }
      }
    };

    function btnSmall(label, onClick, title='') {
      const b = document.createElement('button');
      b.className = 'btn small';
      b.textContent = label;
      b.title = title || label;
      b.onclick = onClick;
      return b;
    }
    function btnSmallDanger(label, onClick) {
      const b = btnSmall(label, onClick);
      b.classList.add('danger');
      return b;
    }

    const shortLink = (item) => {
      const url = new URL(window.location.href);
      if (!item.slug) return (url.origin + url.pathname + '?go=' + generateSlug());
      url.searchParams.set('go', item.slug);
      url.hash = '';
      return url.toString();
    };

    function render() {
      if (!currentUser) return;
      renderFilters();
      const list = getFilteredSorted();
      tbody.innerHTML = '';

      list.forEach(i => {
        const tr = document.createElement('tr');

        const tdChk = document.createElement('td');
        tdChk.innerHTML = `<input type="checkbox" data-id="${i.id}" />`;
        tr.appendChild(tdChk);

        const tdLink = document.createElement('td');
        tdLink.innerHTML = `
          <div class="url-cell">
            <div class="url-title">${escapeHtml(i.title || i.url || '(untitled)')}</div>
            <div class="url">${escapeHtml(i.url)}</div>
            ${i.note ? `<div class="hint">${escapeHtml(i.note)}</div>` : ''}
          </div>
        `;
        tr.appendChild(tdLink);

        const tdTags = document.createElement('td');
        const tagsWrap = document.createElement('div');
        tagsWrap.className = 'tags';
        (i.tags || []).forEach(t => {
          const span = document.createElement('span');
          span.className = 'tag';
          span.textContent = '#' + t;
          span.style.cursor = 'pointer';
          span.title = 'Filter by #' + t;
          span.onclick = () => { filterTags.add(t); render(); };
          tagsWrap.appendChild(span);
        });
        tdTags.appendChild(tagsWrap);
        tr.appendChild(tdTags);

        // Category column
        const tdCategory = document.createElement('td');
        const cat = getCategoryById(i.category);
        if (cat) tdCategory.appendChild(makeCatPill(cat));
        else tdCategory.innerHTML = '<span class="hint">—</span>';
        tr.appendChild(tdCategory);

        const tdClicks = document.createElement('td');
        tdClicks.innerHTML = `
          <div><strong>${i.clickCount || 0}</strong> clicks</div>
          <div class="hint">${i.lastOpened ? 'Last opened ' + timeAgo(i.lastOpened) : 'Never opened'}</div>
        `;
        tr.appendChild(tdClicks);

        const tdStatus = document.createElement('td');
        let pillClass = 'status-unknown', pillText = 'Unknown';
        if (i.status && typeof i.status.code === 'number') {
          if (i.status.ok) { pillClass = 'status-ok'; pillText = 'OK ' + i.status.code; }
          else { pillClass = 'status-bad'; pillText = (i.status.code ? i.status.code : 'Error'); }
        }
        const lastCheck = i.status && i.status.checkedAt ? ' • ' + timeAgo(i.status.checkedAt) : '';
        tdStatus.innerHTML = `<span class="status-pill ${pillClass}">${pillText}${lastCheck}</span>`;
        tr.appendChild(tdStatus);

        const tdActions = document.createElement('td');
        tdActions.className = 'cell-actions';
        tdActions.append(
          btnSmall('Open', () => openItem(i.id), 'Open in new tab'),
          btnSmall('Copy', () => copy(i.url), 'Copy URL'),
          btnSmall('Short', () => copy(shortLink(i)), 'Copy short link'),
          btnSmall('Check', () => checkStatus(i.id), 'Check link status'),
          btnSmall(i.pinned ? 'Unpin' : 'Pin', () => togglePin(i.id), 'Toggle pin'),
          btnSmall('Edit', () => openModal(i.id), 'Edit'),
          btnSmallDanger('Delete', () => deleteItem(i.id))
        );
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });

      el('#statTotal').textContent = items.length;
      el('#statShown').textContent = list.length;
      el('#statClicks').textContent = items.reduce((a,b) => a + (b.clickCount||0), 0);

      // Persist settings
      const s = loadSettingsFor(currentUser.id);
      s.sortBy = sortBy;
      saveSettingsFor(currentUser.id, s);

      el('#sortBy').value = sortBy;
    }

    // ---------- Actions ----------
    function saveItems(itemsNew=items) {
      if (!currentUser) return;
      saveItemsFor(currentUser.id, itemsNew);
    }

    function openItem(id) {
      const i = items.find(x => x.id === id);
      if (!i) return;
      i.clickCount = (i.clickCount || 0) + 1;
      i.lastOpened = now();
      saveItems(items);
      window.open(i.url, '_blank', 'noopener,noreferrer');
      render();
    }

    function togglePin(id) {
      const i = items.find(x => x.id === id);
      if (!i) return;
      i.pinned = !i.pinned;
      i.updatedAt = now();
      saveItems(items);
      render();
    }

    function deleteItem(id) {
      const i = items.find(x => x.id === id);
      if (!i) return;
      if (!confirm('Delete this link?\n\n' + (i.title || i.url))) return;
      items = items.filter(x => x.id !== id);
      saveItems(items);
      render();
      toast('Deleted');
    }

    function generateSlug() {
      const charset = 'abcdefghijklmnopqrstuvwxyz0123456789';
      let s = '';
      for (let i=0;i<6;i++) s += charset[Math.floor(Math.random()*charset.length)];
      if (items.some(x => x.slug === s)) return generateSlug();
      return s;
    }

    async function headOrGet(url, timeoutMs=8000) {
      try {
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), timeoutMs);
        let res = await fetch(url, { method: 'HEAD', mode: 'cors', redirect: 'follow', signal: controller.signal });
        clearTimeout(t);
        if (res.type === 'opaque') return { code: 0, ok: false, note: 'Opaque (CORS)', checkedAt: now() };
        return { code: res.status, ok: res.ok, checkedAt: now() };
      } catch {
        try {
          const controller2 = new AbortController();
          const t2 = setTimeout(() => controller2.abort(), timeoutMs);
          const res2 = await fetch(url, { method: 'GET', mode: 'cors', redirect: 'follow', signal: controller2.signal });
          clearTimeout(t2);
          if (res2.type === 'opaque') return { code: 0, ok: false, note: 'Opaque (CORS)', checkedAt: now() };
          return { code: res2.status, ok: res2.ok, checkedAt: now() };
        } catch {
          return { code: null, ok: false, note: 'Network error', checkedAt: now() };
        }
      }
    }

    function setStatus(item, result) {
      item.status = { code: result.code, ok: !!result.ok, note: result.note || '', checkedAt: result.checkedAt || now() };
    }

    async function checkStatus(id) {
      const i = items.find(x => x.id === id);
      if (!i) return;
      setStatus(i, { code: null, ok: false, note: 'Checking…', checkedAt: now() });
      render();
      const result = await headOrGet(i.url, 10000);
      setStatus(i, result);
      saveItems(items);
      render();
    }

    async function bulkCheckShown() {
      const list = getFilteredSorted();
      for (const i of list) {
        const res = await headOrGet(i.url, 8000);
        setStatus(i, res);
        saveItems(items);
        render();
        await new Promise(r => setTimeout(r, 150));
      }
      toast('Status check completed for ' + list.length + ' links');
    }

    function openModal(id=null) {
      editingId = id;
      el('#modalTitle').textContent = id ? 'Edit URL' : 'Add URL';
      const it = id ? items.find(x => x.id === id) : null;

      el('#f_url').value = it?.url || '';
      el('#f_title').value = it?.title || '';
      el('#f_tags').value = (it?.tags || []).join(', ');
      el('#f_slug').value = it?.slug || '';
      el('#f_note').value = it?.note || '';
      el('#f_pin').checked = !!it?.pinned;
      const catSel = el('#f_category'); if (catSel) catSel.value = it?.category || '';
      el('#utm_toggle').checked = false;
      el('#utm_fields').classList.add('hidden');
      el('#utm_source').value = '';
      el('#utm_medium').value = '';
      el('#utm_campaign').value = '';
      el('#utm_term').value = '';
      el('#utm_content').value = '';
      el('#utm_preview').textContent = '';

      el('#deleteBtn').style.display = id ? 'inline-flex' : 'none';
      el('#modal').classList.add('open');
      setTimeout(() => el('#f_url').focus(), 0);
    }
    function closeModal() { el('#modal').classList.remove('open'); editingId = null; }

    // ---------- Short link redirect (per-user) ----------
    function maybeRedirectForUser() {
      try {
        const u = new URL(window.location.href);
        const slug = u.searchParams.get('go');
        if (!slug) return false;
        const i = items.find(x => x.slug === slug);
        if (i) {
          i.clickCount = (i.clickCount || 0) + 1;
          i.lastOpened = now();
          saveItems(items);
          location.replace(i.url);
          return true;
        } else {
          toast('Short link not found in your account');
          return false;
        }
      } catch { return false; }
    }

    // ---------- Wire up UI ----------
    el('#addBtn').onclick = () => openModal(null);
    el('#closeModal').onclick = closeModal;
    el('#modal').addEventListener('click', (e) => { if (e.target === el('#modal')) closeModal(); });
    el('#genSlug').onclick = () => { el('#f_slug').value = generateSlug(); };
    el('#utm_toggle').addEventListener('change', (e) => { el('#utm_fields').classList.toggle('hidden', !e.target.checked); });
    el('#utm_preview_btn').onclick = () => {
      const base = el('#f_url').value.trim();
      if (!base) return;
      const preview = buildUtm(base, {
        source: el('#utm_source').value.trim(),
        medium: el('#utm_medium').value.trim(),
        campaign: el('#utm_campaign').value.trim(),
        term: el('#utm_term').value.trim(),
        content: el('#utm_content').value.trim(),
      });
      el('#utm_preview').textContent = preview;
    };
    el('#fetchTitle').onclick = async () => {
      const url = el('#f_url').value.trim();
      if (!url) return;
      try {
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), 8000);
        const res = await fetch(url, { mode: 'cors', redirect: 'follow', signal: controller.signal });
        clearTimeout(t);
        const text = await res.text();
        const m = text.match(/<title[^>]*>([^<]*)<\/title>/i);
        const found = (m && m[1] || '').trim();
        if (found) { el('#f_title').value = found; toast('Title fetched'); }
        else { const host = fmtUrlHost(url); el('#f_title').value ||= host; toast('Could not parse title; used host'); }
      } catch { const host = fmtUrlHost(url); el('#f_title').value ||= host; toast('Fetch blocked by CORS; used host'); }
    };
    el('#deleteBtn').onclick = () => { if (!editingId) return; deleteItem(editingId); closeModal(); };

    el('#form').addEventListener('submit', (e) => {
      e.preventDefault();
      const rawUrl = el('#f_url').value.trim();
      if (!rawUrl) return;

      const utmOn = el('#utm_toggle').checked;
      const urlFinal = utmOn ? buildUtm(rawUrl, {
        source: el('#utm_source').value.trim(),
        medium: el('#utm_medium').value.trim(),
        campaign: el('#utm_campaign').value.trim(),
        term: el('#utm_term').value.trim(),
        content: el('#utm_content').value.trim(),
      }) : rawUrl;

      const chosenCat = (el('#f_category')?.value || '').trim();

      const item = {
        title: el('#f_title').value.trim(),
        url: urlFinal,
        normalizedUrl: normalizeUrl(urlFinal),
        tags: toTags(el('#f_tags').value),
        category: chosenCat || undefined,
        slug: (el('#f_slug').value || '').trim() || undefined,
        note: el('#f_note').value.trim(),
        pinned: el('#f_pin').checked,
        updatedAt: now(),
      };

      if (editingId) {
        const idx = items.findIndex(x => x.id === editingId);
        if (idx >= 0) items[idx] = { ...items[idx], ...item };
        toast('Updated');
      } else {
        const newItem = { ...item, id: uid(), createdAt: now(), clickCount: 0, lastOpened: 0, status: null };
        items.unshift(newItem);
        toast('Added');
      }

      // Deduplicate by normalizedUrl (keep first)
      const seen = new Set();
      items = items.filter(i => {
        const key = i.normalizedUrl || i.url;
        if (seen.has(key)) return false;
        seen.add(key); return true;
      });

      saveItems(items);
      render();
      closeModal();
    });

    // Search & sort
    el('#sortBy').addEventListener('change', (e) => { sortBy = e.target.value; render(); });
    const doSearch = debounce(() => {
      filterText = qInput.value;
      const tagMatches = (filterText.match(/#([a-z0-9_-]+)/gi) || []).map(s => s.slice(1).toLowerCase());
      filterTags = new Set(tagMatches);
      render();
    }, 180);
    el('#q').addEventListener('input', doSearch);
    el('#clearFilters').onclick = () => { filterText = ''; filterTags.clear(); qInput.value=''; render(); };
    window.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') { e.preventDefault(); qInput.focus(); }
    });

    // Category filter
    const catFilterEl = el('#catFilter');
    if (catFilterEl) {
      catFilterEl.addEventListener('change', (e) => {
        filterCategory = e.target.value || '';
        render();
      });
    }

    // Add new category (quick add)
    const addCatBtn = el('#addCatBtn');
    const addCatFields = el('#addCatFields');
    const saveCatBtn = el('#saveCatBtn');
    if (addCatBtn && addCatFields && saveCatBtn) {
      addCatBtn.addEventListener('click', () => {
        addCatFields.classList.toggle('hidden');
        el('#newCatName').focus();
      });
      const addCategory = () => {
        const name = (el('#newCatName').value || '').trim();
        const color = el('#newCatColor').value || '#7f8c8d';
        if (!name) return;
        let id = slugify(name);
        if (!id) id = 'cat';
        let base = id, k = 1;
        while (categories.some(c => c.id === id)) { id = `${base}-${++k}`; }
        categories.push({ id, name, color });
        saveCategories(categories);
        renderCategoryControls();
        addCatFields.classList.add('hidden');
        el('#newCatName').value = '';
        el('#f_category').value = id;
        toast('Category added');
      };
      saveCatBtn.addEventListener('click', addCategory);
      el('#newCatName').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); addCategory(); }
      });
    }

    // Import/Export
    el('#exportBtn').onclick = () => {
      if (!currentUser) return;
      const data = JSON.stringify(items, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'url-tracker-export-' + new Date().toISOString().slice(0,10) + '.json';
      a.click();
      URL.revokeObjectURL(a.href);
    };
    el('#importFile').addEventListener('change', async (e) => {
      if (!currentUser) return;
      const file = e.target.files[0]; if (!file) return;
      const text = await file.text();
      try {
        const imported = JSON.parse(text);
        if (!Array.isArray(imported)) throw new Error('Invalid format');
        const byId = new Map(items.map(i => [i.id, i]));
        const byNorm = new Map(items.map(i => [i.normalizedUrl || i.url, i]));
        let count = 0;
        for (const it of imported) {
          if (it.id && byId.has(it.id)) continue;
          const key = it.normalizedUrl || it.url;
          if (key && byNorm.has(key)) continue;
          items.push({ ...it, id: it.id || uid() });
          count++;
        }
        saveItems(items);
        render();
        toast(`Imported ${count} items`);
      } catch (err) {
        alert('Import failed: ' + err.message);
      } finally { e.target.value = ''; }
    });

    // Bulk status
    el('#bulkCheck').onclick = bulkCheckShown;

    // Sign out
    el('#signOutBtn').addEventListener('click', () => {
      clearSession();
      currentUser = null;
      items = [];
      document.title = 'URL Tracker & Manager • Auth';
      el('#userArea').classList.add('hidden');
      showAuth();
    });

    // ---------- Session bootstrap ----------
    (async function boot() {
      const sess = getSession();
      if (!sess) { showAuth(); return; }
      const users = loadUsers();
      const user = users.find(u => u.id === sess.userId);
      if (!user) { clearSession(); showAuth(); return; }
      currentUser = user;
      await initAppForUser(user);
    })();
  </script>
</body>
</html>